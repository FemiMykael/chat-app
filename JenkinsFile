pipeline {
    agent any

    environment {
        REMOTE_HOST = '3.219.208.168'
        SSH_CRED_ID = 'chat-ec2-key'
        PRIVATE_KEY_PATH = '/var/lib/jenkins/.ssh/chat-ci'
    }

    stages {
        stage('Checkout Code') {
            steps {
                git url: 'https://github.com/FemiMykael/chat-app.git', branch: 'master'
            }
        }

        stage('Run Ansible Playbook') {
            steps {
                sshagent(credentials: [env.SSH_CRED_ID]) {
                    sh '''
                        echo "Running Ansible playbook on remote server..."
                        /usr/bin/ansible-playbook -i ${REMOTE_HOST}, ./ansible/site.yml --private-key ${PRIVATE_KEY_PATH} -u ubuntu
                    '''
                }
            }
        }

        stage('Restart App') {
            steps {
                sshagent(credentials: [env.SSH_CRED_ID]) {
                    sh '''
                        echo "Restarting chat-app with PM2..."
                        ssh -o StrictHostKeyChecking=no -i ${PRIVATE_KEY_PATH} ubuntu@${REMOTE_HOST} 'pm2 restart chat-app --update-env || pm2 start chat-app/app.js --name chat-app'
                    '''
                }
            }
        }
    }
}

